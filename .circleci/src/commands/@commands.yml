create_concatenated_patch_file:
  description: 'Concatenate all patch-files into single file. File is used as checksum source for part of caching key.'
  parameters:
    filename:
      type: string
  steps:
    - run:
        name: Combine patch-files to single file
        command: ls -d -- packages/*/patches/*.patch | xargs cat > << parameters.filename >>

restore_node_cache:
  description: 'Restore node_modules cache with standardized keys'
  parameters:
    include_arch:
      type: boolean
      default: false
  steps:
    - restore_cache:
        keys:
          # Primary cache key with Node version
          - npm-cache-v1-{{ checksum "package-lock.json" }}-{{ checksum "combined-patch-file.txt" }}-{{ .Environment.NODE_VERSION }}{{ if parameters.include_arch }}-{{ arch }}{{ endif }}
          # Fallback cache key without Node version
          - npm-cache-v1-{{ checksum "package-lock.json" }}-{{ checksum "combined-patch-file.txt" }}{{ if parameters.include_arch }}-{{ arch }}{{ endif }}
          # Fallback to most recent cache
          - npm-cache-v1-

save_node_cache:
  description: 'Save node_modules cache with standardized keys'
  parameters:
    include_arch:
      type: boolean
      default: false
    paths:
      type: string
      default: |
        - ./node_modules
        - ./packages/*/node_modules
        - ./packages/dotenv-linter/bin
        - ./packages/discovery-provider/plugins/pedalboard/apps/*/node_modules
  steps:
    - save_cache:
        key: npm-cache-v1-{{ checksum "package-lock.json" }}-{{ checksum "combined-patch-file.txt" }}-{{ .Environment.NODE_VERSION }}{{ if parameters.include_arch }}-{{ arch }}{{ endif }}
        paths: << parameters.paths >>

restore_python_cache:
  description: 'Restore Python dependencies cache'
  parameters:
    requirements_file:
      type: string
  steps:
    - restore_cache:
        keys:
          - python-cache-v1-{{ checksum parameters.requirements_file }}-{{ .Environment.PYTHON_VERSION }}
          - python-cache-v1-{{ checksum parameters.requirements_file }}
          - python-cache-v1-

save_python_cache:
  description: 'Save Python dependencies cache'
  parameters:
    requirements_file:
      type: string
  steps:
    - save_cache:
        key: python-cache-v1-{{ checksum parameters.requirements_file }}-{{ .Environment.PYTHON_VERSION }}
        paths:
          - '~/.cache/pip'
          - '/usr/local/lib/python3.*/site-packages'
          - '/usr/local/lib/site-python'

restore_ruby_cache:
  description: 'Restore Ruby gems cache'
  parameters:
    gemfile_lock:
      type: string
  steps:
    - restore_cache:
        keys:
          - ruby-cache-v1-{{ checksum parameters.gemfile_lock }}-{{ .Environment.RUBY_VERSION }}
          - ruby-cache-v1-{{ checksum parameters.gemfile_lock }}
          - ruby-cache-v1-

save_ruby_cache:
  description: 'Save Ruby gems cache'
  parameters:
    gemfile_lock:
      type: string
    vendor_path:
      type: string
  steps:
    - save_cache:
        key: ruby-cache-v1-{{ checksum parameters.gemfile_lock }}-{{ .Environment.RUBY_VERSION }}
        paths:
          - << parameters.vendor_path >>
