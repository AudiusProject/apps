parameters:
  service:
    description: 'Service to deploy (creator-node, discovery-provider, identity-service, ddex)'
    type: string
resource_class: small
docker:
  - image: cimg/base:2023.01
steps:
  - configure-github-access
  - run:
      name: Update tag in audius-docker-compose stage branch
      command: |
        git clone --branch stage https://github.com/AudiusProject/audius-docker-compose.git audius-docker-compose
        cd audius-docker-compose
        sed -i "s/\({TAG:-\)[^}]*\}/\1$CIRCLE_SHA1}/" << parameters.service >>/docker-compose*.yml
        git add */docker-compose*.yml
        git commit -m "Update tag to $CIRCLE_SHA1 for << parameters.service >>"
        git push origin stage
  - docker-tag-images:
      tag: prerelease
      service: << parameters.service >>
  - run:
      name: Wait for 2 minutes for staging nodes to auto-upgrade
      command: sleep 120
