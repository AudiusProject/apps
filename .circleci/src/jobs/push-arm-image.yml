parameters:
  service:
    description: 'Service to push'
    type: string
resource_class: arm.medium
machine:
  image: ubuntu-2204:current
steps:
  - checkout:
      path: '~/audius-protocol'
  - run: AUDIUS_DEV=false bash ~/audius-protocol/dev-tools/setup.sh
  - run:
      name: Docker login
      command: echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  - run:
      name: Install buildx
      command: docker buildx create --use
  - run: docker buildx version && docker buildx ls
  - run: . ~/.profile; audius-compose build --prod "<< parameters.service >>"
  - run: docker inspect --format='{{.Os}}/{{.Architecture}}' audius-protocol-discovery-provider
  - run:
      name: Merge and push new tag manifest
      command: . ~/.profile; audius-compose push-arm --prod "<< parameters.service >>"

