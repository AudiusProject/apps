docker:
  - image: cimg/node:18.17
steps:
  - checkout

  - restore_cache:
      keys:
        - sdk-cache-{{ checksum "packages/libs/package-lock.json" }}
        - sdk-cache-
  - run:
      name: Install sdk
      command: |
        cd packages/libs
        npm install
        npm run build:sdk
  - save_cache:
      key: sdk-cache-{{ checksum "packages/libs/package-lock.json" }}
      paths:
        - ./packages/libs/node_modules

  - restore_cache:
      keys:
        - eth-contracts-cache-{{ checksum "eth-contracts/package-lock.json" }}
        - eth-contracts-cache-
  - run:
      name: Install eth-contracts dependencies
      command: |
        cd eth-contracts
        npm install
  - save_cache:
      key: eth-contracts-cache-{{ checksum "eth-contracts/package-lock.json" }}
      paths:
        - ./eth-contracts/node_modules

  - run:
      name: Governance Release
      command: |
        export RELEASE_VERSION="$(jq -r .version packages/discovery-provider/.version.json)"
        export RELEASE_HASH="<< pipeline.git.revision >>"
        export ADDITIONAL_NOTES="We want to call out an important new proposed reward type in this proposed protocol upgrade: AUDIO match. Alongside the upcoming USDC support being launched, this reward type would match every USDC token spent by a fan on an artist's offerings with an AUDIO token for both fan and artist from the pre-existing rewards system (see here for more: https://blog.audius.co/article/proposing-audio-rewards-on-solana). It includes important sybil resistance mechanics and other functionality as well - we would encourage review of the codebase to fully understand it before placing a vote."

        cd eth-contracts
        node scripts/release-governance.js

  - slack/notify:
      custom: |
        {
          "blocks": [
            {
              "type": "section",
              "text": {
                "text": "New Governance Proposals are out @ https://dashboard.audius.org/#/governance"
                "type": "mrkdwn"
              },
              "accessory": {
                "type": "button",
                "text": {
                  "type": "plain_text",
                  "text": "View Job"
                },
                "url": "$CIRCLE_BUILD_URL"
              }
            }
          ]
        }
      mentions: $SLACK_RELEASE_MENTIONS
