parameters:
  service:
    description: 'Service to test'
    type: string
machine: true
resource_class: audiusproject/gcp-n2-standard-4
steps:
  - checkout:
      path: '~/audius-protocol'
  - attach_workspace:
      at: ./
  - create_concatenated_patch_file:
      filename: combined-patch-file.txt
  - restore_cache:
      keys:
        - cache-{{ checksum "package-lock.json" }}-{{ checksum "combined-patch-file.txt" }}
  - persist_to_workspace:
      root: ./
      paths:
        - node_modules
        - packages/discovery-provider/es-indexer/node_modules
  - run: AUDIUS_DEV=false bash ~/audius-protocol/dev-tools/setup.sh
  - run:
      name: test run "<< parameters.service >>"
      no_output_timeout: 20m
      command: . ~/.profile; audius-compose test run "<< parameters.service >>"
  - run:
      name: cleanup
      no_output_timeout: 5m
      command: . ~/.profile; audius-compose test down
      when: always
