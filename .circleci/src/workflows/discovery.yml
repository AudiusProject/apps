when: << pipeline.parameters.run-discovery-workflow >>
jobs:
  - build-gcp-image:
      context: GCP

  - push-docker-image:
      name: push-discovery-provider
      context: [GCP, dockerhub]
      instance-name: circleci-push-discovery-provider-$CIRCLE_BUILD_NUM
      service: discovery-provider
  - push-docker-image:
      name: push-discovery-provider-notifications
      context: [GCP, dockerhub]
      instance-name: circleci-push-discovery-provider-notifications-$CIRCLE_BUILD_NUM
      service: discovery-provider-notifications
  - push-docker-image:
      name: push-comms
      context: [GCP, dockerhub]
      instance-name: circleci-push-comms-$CIRCLE_BUILD_NUM
      service: comms

  - test:
      name: test-discovery-provider
      context: GCP
      instance-name: circleci-test-discovery-provider-$CIRCLE_BUILD_NUM
      service: discovery-provider
  - test:
      name: test-discovery-provider-notifications
      context: GCP
      instance-name: circleci-test-discovery-provider-notifications-$CIRCLE_BUILD_NUM
      service: discovery-provider-notifications
  - test-audius-cmd:
      context: GCP
      instance-name: circleci-test-audius-cmd-$CIRCLE_BUILD_NUM

  # Release
  - deploy-prod-discovery-provider-trigger:
      requires:
        - push-discovery-provider
      filters:
        branches:
          only: /^release-v.*$/
      type: approval
  - deploy:
      name: deploy-prod-discovery-provider
      context: open-vpn
      requires:
        - deploy-prod-discovery-provider-trigger
      hosts: >-
        prod-discovery-1
        prod-discovery-2
        prod-discovery-3
      service: discovery-provider

  # Main deploy
  - deploy:
      name: deploy-stage-discovery-provider
      requires:
        - push-discovery-provider
        - push-comms
      filters:
        branches:
          only: main
      context:
        - open-vpn
        - build-freeze
      hosts: >-
        stage-discovery-4
        stage-discovery-1
        stage-discovery-2
        stage-discovery-3
        stage-discovery-5
      service: discovery-provider
      freeze: $FREEZE_BUILD

  - deploy:
      name: deploy-stage-discovery-provider-notifications
      requires:
        - push-discovery-provider-notifications
      filters:
        branches:
          only: main
      context:
        - open-vpn
        - build-freeze
      hosts: >-
        stage-discovery-2
      service: discovery-provider-notifications
      freeze: $FREEZE_BUILD
