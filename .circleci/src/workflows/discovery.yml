when: << pipeline.parameters.run-discovery-workflow >>
jobs:
  - push-docker-image:
      name: push-discovery-provider
      context: [Vercel, dockerhub]
      service: discovery-provider
      filters:
        branches:
          only: /(^main|^rj-discovery-build)/

  - push-docker-image:
      name: push-discovery-provider-openresty
      context: [Vercel, dockerhub]
      service: discovery-provider-openresty
      filters:
        branches:
          only: /(^main|^rj-discovery-build)/

  - push-docker-image:
      name: push-discovery-provider-comms
      context: [Vercel, dockerhub]
      service: comms
      filters:
        branches:
          only: /(^main|^rj-discovery-build)/

  - push-docker-image:
      name: push-discovery-provider-plugins
      context: [Vercel, dockerhub]
      service: discovery-provider-notifications trending-challenge-rewards staking relay solana-relay crm mri verified-notifications anti-abuse archiver es-indexer
      filters:
        branches:
          only: /(^main|^rj-discovery-build)/

  - lint-discovery-provider:
      name: lint-discovery-provider

  - test:
      name: test-discovery-provider
      context: Vercel
      service: discovery-provider
      requires:
        - lint-discovery-provider
  - test:
      name: test-discovery-provider-notifications
      context: Vercel
      service: discovery-provider-notifications
      requires:
        - lint-discovery-provider

  # Deploy audius-protocol `main` branch (stage)
  - deploy-stage-nodes-just-tag:
      name: deploy-stage-discovery-provider
      requires:
        - lint-discovery-provider
        - test-discovery-provider
        - push-discovery-provider

      filters:
        branches:
          only: main
      context: github
      service: discovery-provider
