when: << pipeline.parameters.run-identity-workflow >>
jobs:
  - push-docker-image:
      name: push-identity-service
      context: [GCP, dockerhub]
      service: identity-service
      filters:
        branches:
          only: 
            - main
            - '/release-v\d+\.\d+\.\d+/'

  - test:
      name: test-identity-service
      context: GCP
      service: identity-service

  # Deploy audius-protocol `main` branch (stage)
  - deploy-stage-nodes:
      name: deploy-stage-identity-service
      requires:
        - test-identity-service
        - push-identity-service
      filters:
        branches:
          only: main
      context: github
      service: identity-service
