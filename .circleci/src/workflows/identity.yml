when: << pipeline.parameters.run-identity-workflow >>
jobs:
  - push-docker-image:
      name: push-identity-service
      context: [GCP, dockerhub]
      instance-name: circleci-push-identity-service-$CIRCLE_BUILD_NUM
      service: identity-service

  - test:
      name: test-identity-service
      context: GCP
      instance-name: circleci-test-identity-service-$CIRCLE_BUILD_NUM
      service: identity-service

  # Release
  - deploy-prod-identity-service-trigger:
      requires:
        - test-identity-service
        - push-identity-service
      filters:
        branches:
          only: /^release.*$/
      type: approval
  - deploy:
      name: deploy-prod-identity-service
      context:
        - open-vpn
        - slack-secrets
      requires:
        - deploy-prod-identity-service-trigger
      hosts: prod-identity
      service: identity-service

  # Main deploy
  - deploy:
      name: deploy-stage-identity-service
      requires:
        - test-identity-service
        - push-identity-service
      filters:
        branches:
          only: main
      context:
        - open-vpn
        - build-freeze
        - slack-secrets
      hosts: stage-identity
      service: identity-service
      freeze: $FREEZE_BUILD
