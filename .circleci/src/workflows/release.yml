when: << pipeline.parameters.run-release-workflow >>
jobs:
  - push-docker-image:
      name: push-discovery-provider
      context: [GCP, dockerhub]
      instance-name: circleci-push-discovery-provider-$CIRCLE_BUILD_NUM
      service: discovery-provider
  - push-docker-image:
      name: push-mediorum
      context: [GCP, dockerhub]
      instance-name: circleci-push-mediorum-$CIRCLE_BUILD_NUM
      service: mediorum
  - push-docker-image:
      name: push-identity-service
      context: [GCP, dockerhub]
      instance-name: circleci-push-identity-service-$CIRCLE_BUILD_NUM
      service: identity-service

  - release-github-draft-trigger:
      filters:
        branches:
          only: /^release.*$/
      type: approval
  - release-github-draft:
      context: github
      requires:
        - release-github-draft-trigger

  - release-github-trigger:
      requires:
        - release-github-draft
      type: approval
  - release-github:
      context: github
      requires:
        - release-github-trigger

  - release-governance-trigger:
      filters:
        branches:
          only: /^release.*$/
      type: approval
  - release-governance:
      context: governance
      requires:
        - release-governance-trigger

  - release-audius-docker-compose-trigger:
      requires:
        - push-mediorum
        - push-discovery-provider
        - push-identity-service
      filters:
        branches:
          only: /^release.*$/
      type: approval
  - release-audius-docker-compose:
      context: github
      requires:
        - release-audius-docker-compose-trigger

  - release-discord-trigger:
      filters:
        branches:
          only: /^release.*$/
      type: approval
  - release-discord:
      context: discord
      requires:
        - release-discord-trigger
