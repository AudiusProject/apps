when: << pipeline.parameters.run-sdk-workflow >>
jobs:
  - test:
      name: test-audius-libs
      context: GCP
      instance-name: circleci-test-audius-libs-$CIRCLE_BUILD_NUM
      service: audius-libs

  # Prepatch from main
  - release-audius-sdk:
      requires:
        - release-audius-sdk-trigger
      filters:
        branches:
          only: /^main$/
      sdk-release-commit: $CIRCLE_SHA1
      sdk-release-version: prerelease
      sdk-release-preid: ""
      context:
        - Audius Client
        - slack-secrets

  # Patch via trigger
  - release-audius-sdk-trigger:
      requires:
        - test-audius-libs
      filters:
        branches:
          only: /(^main)|(^release.*)$/
      type: approval
  - release-audius-sdk:
      requires:
        - release-audius-sdk-trigger
      sdk-release-commit: $CIRCLE_SHA1
      sdk-release-version: patch
      sdk-release-preid: ""
      context:
        - Audius Client
        - slack-secrets
