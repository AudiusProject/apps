version: '3'

x-dev-env: &dev-env
  AUDIUS_REBALANCE_INTERVAL_HOURS: "0.005" # check for unhealthy nodes and update healthy node set every 18 seconds
  AUDIUS_HEALTH_TTL_HOURS: "0.005" # consider a node unhealthy if it hasn't self-reported "OK" status in the last 18 seconds
  AUDIUS_REPORT_OK_INTERVAL_SECONDS: 4
  AUDIUS_NATS_ENABLE_JETSTREAM: true
  AUDIUS_DEV_ONLY_REGISTERED_NODES: '
        [
          {
            "id": "content-node::1",
            "spId": "1",
            "endpoint": "http://node1-storage",
            "delegateOwnerWallet": "0x1c185053c2259f72fd023ED89B9b3EBbD841DA0F",
            "spOwnerWallet": "0x",
            "type": { "id": "content-node" }
          },
          {
            "id": "content-node::2",
            "spId": "2",
            "endpoint": "http://node2-storage",
            "delegateOwnerWallet": "0x90b8d2655A7C268d0fA31758A714e583AE54489D",
            "spOwnerWallet": "0x",
            "type": { "id": "content-node" }
          },
          {
            "id": "content-node::3",
            "spId": "3",
            "endpoint": "http://node3-storage",
            "delegateOwnerWallet": "0xb7b9599EeB2FD9237C94cFf02d74368Bb2df959B",
            "spOwnerWallet": "0x",
            "type": { "id": "content-node" }
          },
          {
            "id": "content-node::4",
            "spId": "4",
            "endpoint": "http://node4-storage",
            "delegateOwnerWallet": "0xfa4f42633Cb0c72Aa35D3D1A3566abb7142c7b16",
            "spOwnerWallet": "0x",
            "type": { "id": "content-node" }
          },
          {
            "id": "discovery-node::1",
            "spId": "5",
            "endpoint": "http://node1-discovery",
            "delegateOwnerWallet": "0x123d0813710D55A9C38A2D7BC502Ff00A1a0279e",
            "spOwnerWallet": "0x",
            "type": { "id": "discovery-node" }
          },
          {
            "id": "discovery-node::2",
            "spId": "6",
            "endpoint": "http://node2-discovery",
            "delegateOwnerWallet": "0x9262c9A1b172fF2A9C027B55862389d00b68A26a",
            "spOwnerWallet": "0x",
            "type": { "id": "discovery-node" }
          },
          {
            "id": "discovery-node::3",
            "spId": "7",
            "endpoint": "http://node3-discovery",
            "delegateOwnerWallet": "0xBc2550Ae74fbbDF4eC30A8E65dd845a5a8510eb4",
            "spOwnerWallet": "0x",
            "type": { "id": "discovery-node" }
          }
        ]'

x-extra-hosts: &extra-hosts
  extra_hosts:
    - "node1-storage:host-gateway"
    - "node2-storage:host-gateway"
    - "node3-storage:host-gateway"
    - "node4-storage:host-gateway"
    - "node1-discovery:host-gateway"
    - "node2-discovery:host-gateway"
    - "node3-discovery:host-gateway"

services:
  test:
    container_name: test
    build:
      context: .
      dockerfile: Dockerfile.v2
      target: builder
    image: "comms:v2-test"
    environment:
      <<: *dev-env
      AUDIUS_DELEGATE_PRIVATE_KEY: "293589cdf207ed2f2253bb72b17bb7f2cfe399cdc34712b1d32908d969682238" # Public key: "0x1c185053c2259f72fd023ED89B9b3EBbD841DA0F"
      AUDIUS_TEST_HOST: "nats1-storage"
      NATS_SERVER_URL: "nats://nats1-storage:4222"
      audius_db_url: "postgresql://postgres:postgres@comdb:5432/audius_discovery?sslmode=disable"
    command: -c .air.test.toml
    <<: *extra-hosts
    volumes:
      - ./:/app

  comdb:
    container_name: comdb
    image: postgres
    restart: unless-stopped
    ports:
      - 5454:5432
    environment:
      POSTGRES_PASSWORD: postgres
    volumes:
      - ./discovery/db/docker-initdb:/docker-entrypoint-initdb.d

  nats-dev:
    build:
      context: .
      dockerfile: Dockerfile.v2
      target: builder
    image: "nats:v2-dev"
    restart: unless-stopped
    stop_signal: SIGKILL
    command:
      - nats
    depends_on:
      comdb:
        condition: service_started
      ingress:
        condition: service_started
    environment: *dev-env
    <<: *extra-hosts
    healthcheck:
      # does the cluster have at least 7 nodes peered (4 storage, 3 discovery)?
      test: wget -qO- http://localhost:8924/nats/jsz | grep -o '"cluster_size":[[:space:]]*[0-9]*' | awk '{if ($$2 < 7) {exit 1}}'
      interval: 5s
      retries: 15
      start_period: 10s
      timeout: 1s
    volumes:
      - ./natsd:/app/natsd
      - ./shared:/app/shared

  discovery-dev:
    build:
      context: .
      dockerfile: Dockerfile.v2
      target: builder
    image: "discovery:v2-dev"
    restart: unless-stopped
    stop_signal: SIGKILL
    command:
      - discovery
    environment: *dev-env
    <<: *extra-hosts
    volumes:
      - ./discovery:/app/discovery
      - ./shared:/app/shared

  storage-dev:
    build:
      context: .
      dockerfile: Dockerfile.v2
      target: builder
    image: "storage:v2-dev"
    restart: unless-stopped
    stop_signal: SIGKILL
    command:
      - storage
    environment: *dev-env
    <<: *extra-hosts
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:8926/storage || exit 1
      interval: 3s
      retries: 10
      start_period: 20s
      timeout: 1s
    depends_on:
      ingress:
        condition: service_started
    volumes:
      - ./storage:/app/storage
      - ./shared:/app/shared
      - /app/storage/storageserver/weather-map # exclude weather-map and its heavy node_modules
      - ./storage/storageserver/weather-map/dist:/app/storage/storageserver/weather-map/dist

  nginx:
    image: openresty/openresty:1.21.4.1-alpine-fat
