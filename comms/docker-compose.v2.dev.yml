version: '3'

x-common-variables: &shared-vars
   AUDIUS_DEV_ONLY_REGISTERED_NODES: '
        [
          {
            "id": "content-node::1",
            "spId": "1",
            "endpoint": "http://node1",
            "delegateOwnerWallet": "0x1c185053c2259f72fd023ED89B9b3EBbD841DA0F",
            "type": { "id": "content-node" }
          }
        ]'

services:

  comdb:
    container_name: comdb
    extends:
      file: docker-compose.v2.base.yml
      service: comdb

  sshuttle-server:
    container_name: sshuttle-server
    extends:
      file: docker-compose.v2.base.yml
      service: sshuttle-server

  com1:
    container_name: com1
    extends:
      file: docker-compose.v2.base.yml
      service: nats
    environment:
      audius_discprov_env: standalone # TODO: remove (keeping for now to make sure the standalone code path is still working)
      audius_delegate_private_key: "293589cdf207ed2f2253bb72b17bb7f2cfe399cdc34712b1d32908d969682238" # Public key: "0x1c185053c2259f72fd023ED89B9b3EBbD841DA0F"
      test_host: "com1"
      <<: *shared-vars
    depends_on:
      - comdb
    ports:
      - 8924:8924

  storage1:
    container_name: storage1
    extends:
      file: docker-compose.v2.base.yml
      service: storage
    build:
      dockerfile: Dockerfile.v2.dev
    image: "comms:v2-dev"
    environment:
      audius_discprov_env: standalone # TODO: remove (keeping for now to make sure the standalone code path is still working)
      audius_delegate_private_key: "293589cdf207ed2f2253bb72b17bb7f2cfe399cdc34712b1d32908d969682238" # Remove after shared/peering/ config is in place
      AUDIUS_DELEGATE_PRIVATE_KEY: "293589cdf207ed2f2253bb72b17bb7f2cfe399cdc34712b1d32908d969682238" # Public key: "0x1c185053c2259f72fd023ED89B9b3EBbD841DA0F"
      <<: *shared-vars
      NATS_SERVER_URL: "nats://com1:4222"
      NAME: "storage1"
      test_host: "com1"
    depends_on:
      - com1
    volumes:
      - ./:/app
    ports:
      - 9924:8926
  
  node1:
    container_name: node1
    extends:
      file: docker-compose.v2.base.yml
      service: nginx
    volumes:
      - ./v2_nginx/node1.conf:/etc/nginx/conf.d/default.conf
