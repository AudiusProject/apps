worker_processes 1;

events {
    worker_connections 1024;
}

http {
    lua_package_path "/usr/local/openresty/conf/?.lua;;";

    proxy_cache_path /usr/local/openresty/cache levels=1:2 keys_zone=cidcache:1000m
					max_size=10g inactive=10m use_temp_path=off;

    server {
        listen 4000;

        # Match the path /ipfs/<cid: string>. If present in cache, serve. 
        # Else, hit upstream server + update cache + serve.
        # ^~ : if request matches this route, do not attempt to bypass via the `/` pattern below
        location ^~ /ipfs {
            proxy_cache cidcache;
            proxy_pass http://127.0.0.1:3000;

            # this directive + proxy_cache_background_update -> deliver stale content when client requests
            # an item that is expired or in the process of being updated from origin server
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_background_update on;

            proxy_cache_valid any 10m;
            proxy_cache_lock on;
            proxy_cache_lock_age 5s;

            # Bypass cache with purgecache=true query string and save new response to proxy cache
            proxy_cache_bypass $arg_purgecache;

            # Add header to indicate the status of the cache with this request
            add_header X-Cache-Status $upstream_cache_status always;
        }

        # Pass all other requests to upstream server
        location / {
            proxy_pass http://127.0.0.1:3000;
        }
    }
}