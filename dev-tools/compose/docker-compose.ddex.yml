version: '3.9'

services:
  # ddex-web:
  #   container_name: ddex-web
  #   build:
  #     context: ${PROJECT_ROOT}
  #     dockerfile: ${PROJECT_ROOT}/packages/ddex/webapp/Dockerfile
  #     args:
  #       app_name: ddex-web
  #       TURBO_TEAM: '${TURBO_TEAM}'
  #       TURBO_TOKEN: '${TURBO_TOKEN}'
  #   profiles:
  #     - ddex

  ddex-crawler:
    container_name: ddex-crawler
    build:
      context: ${PROJECT_ROOT}/packages/ddex/ingester
      dockerfile: ${PROJECT_ROOT}/packages/ddex/ingester/Dockerfile
    environment:
      - DDEX_MONGODB_URL=mongodb://mongo:mongo@ddex-mongo:27017/ddex?authSource=admin
    depends_on:
      ddex-mongo:
        condition: service_healthy
    entrypoint: ./ingester --service crawler
    profiles:
      - ddex

  ddex-indexer:
    container_name: ddex-indexer
    build:
      context: ${PROJECT_ROOT}/packages/ddex/ingester
      dockerfile: ${PROJECT_ROOT}/packages/ddex/ingester/Dockerfile
    environment:
      - DDEX_MONGODB_URL=mongodb://mongo:mongo@ddex-mongo:27017/ddex?authSource=admin
    depends_on:
      ddex-mongo:
        condition: service_healthy
    entrypoint: ./ingester --service indexer
    profiles:
      - ddex

  ddex-parser:
    container_name: ddex-parser
    build:
      context: ${PROJECT_ROOT}/packages/ddex/ingester
      dockerfile: ${PROJECT_ROOT}/packages/ddex/ingester/Dockerfile
    environment:
      - DDEX_MONGODB_URL=mongodb://mongo:mongo@ddex-mongo:27017/ddex?authSource=admin
    depends_on:
      ddex-mongo:
        condition: service_healthy
    entrypoint: ./ingester --service parser
    profiles:
      - ddex

  ddex-mongo:
    container_name: ddex-mongo
    image: mongo
    restart: always
    volumes:
      - ddex-mongo-db:/data/db
    environment:
      - MONGO_INITDB_ROOT_USERNAME=mongo
      - MONGO_INITDB_ROOT_PASSWORD=mongo
    ports:
      - "27017:27017"
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh --quiet --username $MONGO_INITDB_ROOT_USERNAME --password $MONGO_INITDB_ROOT_PASSWORD --authenticationDatabase admin localhost:27017/ddex
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    profiles:
      - ddex

volumes:
  ddex-mongo-db:
