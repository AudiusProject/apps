version: '3'

services:
  anti-abuse:
    container_name: anti-abuse
    image: audius/pedalboard:anti-abuse-oracle-edge
    pull_policy: always
    environment:
      IDENTITY_DB_URL: 'postgresql://postgres:postgres@db:5432/identity_service'
      private_signer_address: '${AAO_WALLET_PRIVATE_KEY}'
    restart: always
    profiles:
      - pedalboard

  trending-challenge-rewards:
    container_name: trending-challenge-rewards
    image: audius/pedalboard:trending-challenge-rewards-edge
    pull_policy: always
    restart: always
    profiles:
      - pedalboard

  staking:
    image: audius/pedalboard:staking-edge
    pull_policy: always
    restart: always
    profiles:
      - pedalboard

  relay:
    image: audius/pedalboard:relay-edge
    pull_policy: always
    env_file: .env
    restart: always
    deploy:
      mode: replicated
      replicas: '${DISCOVERY_PROVIDER_REPLICAS}'
    profiles:
      - discovery
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://127.0.0.1:6001/relay/health']
      interval: 1s
      timeout: 1s
      retries: 120
    depends_on:
      db:
        condition: service_healthy
      discovery-provider-redis:
        condition: service_healthy

  solana-relay:
    image: audius/pedalboard:solana-relay-edge
    pull_policy: always
    env_file: .env # used by the startup script
    environment:
      audius_solana_rewards_manager_program_address: '${SOLANA_REWARD_MANAGER_PUBLIC_KEY}'
      audius_solana_rewards_manager_account: '${SOLANA_REWARD_MANAGER_PDA_PUBLIC_KEY}'
      audius_solana_user_bank_program_address: '${SOLANA_CLAIMABLE_TOKENS_PUBLIC_KEY}'
      audius_solana_payment_router_program_address: '${SOLANA_PAYMENT_ROUTER_PUBLIC_KEY}'
      audius_solana_waudio_mint: '${SOLANA_TOKEN_MINT_PUBLIC_KEY}'
      audius_solana_usdc_mint: '${SOLANA_USDC_TOKEN_MINT_PUBLIC_KEY}'
      audius_solana_fee_payer_wallets: '[{"privateKey":${SOLANA_FEEPAYER_SECRET_KEY}}]'
    restart: always
    profiles:
      - discovery
    deploy:
      mode: replicated
      replicas: '${DISCOVERY_PROVIDER_REPLICAS}'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://127.0.0.1:6002/solana/health_check']
      interval: 1s
      timeout: 1s
      retries: 120
    depends_on:
      db:
        condition: service_healthy
      discovery-provider-redis:
        condition: service_healthy
      solana-test-validator:
        condition: service_healthy

  crm:
    container_name: crm
    image: audius/pedalboard:crm-edge
    pull_policy: always
    restart: always
    profiles:
      - pedalboard

  mri:
    container_name: mri
    image: audius/pedalboard:mri-edge
    pull_policy: always
    restart: always
    profiles:
      - pedalboard

  verified-notifications:
    container_name: verified-notifications
    image: audius/pedalboard:verified-notifications-edge
    pull_policy: always
    restart: on-failure
    profiles:
      - pedalboard

  archiver:
    container_name: archiver
    image: audius/pedalboard:archiver-edge
    pull_policy: always
    restart: always
    profiles:
      - pedalboard
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://127.0.0.1:6004/archive/health_check']
      interval: 1s
      timeout: 1s
      retries: 120
    depends_on:
      discovery-provider-redis:
        condition: service_healthy
