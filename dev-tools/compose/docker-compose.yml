version: '3.9'

# TODO: Run nethermind in a container called `chain` like https://github.com/AudiusProject/audius-docker-compose/blob/main/discovery-provider/docker-compose.yml#L247
# This has never existed locally but seems to break discovery indexing when signing up now (was previously working)

x-common: &common
  logging:
    options:
      max-size: '50m'
      max-file: '3'
    driver: json-file
  extra_hosts:
    # Allows the containers can talk to each other via their hostnames routed through nginx
    - 'audius-protocol-comms-1:host-gateway'
    - 'audius-protocol-comms-2:host-gateway'
    - 'audius-protocol-comms-3:host-gateway'
    - 'audius-protocol-creator-node-1:host-gateway'
    - 'audius-protocol-creator-node-2:host-gateway'
    - 'audius-protocol-creator-node-3:host-gateway'
    - 'audius-protocol-discovery-provider-1:host-gateway'
    - 'audius-protocol-discovery-provider-2:host-gateway'
    - 'audius-protocol-discovery-provider-3:host-gateway'
    - 'audius-protocol-identity-service-1:host-gateway'
    - 'audius-protocol-solana-test-validator-1:host-gateway'
    - 'audius-protocol-eth-ganache-1:host-gateway'
    - 'audius-protocol-poa-ganache-1:host-gateway'
    - 'audius-protocol-pedalboard:host-gateway'
  deploy:
    resources:
      limits:
        memory: 3G

services:
  ingress:
    # Nginx ingress for all hostnames. Change nginx_ingress.conf to add more hostnames / routes
    extends:
      file: docker-compose.dev-tools.${DOCKERCOMPOSE_ENV_TYPE:-dev}.yml
      service: ingress
    <<: *common

  db:
    image: postgres:11.4
    shm_size: 2g
    command: postgres -c shared_buffers=2GB -c max_connections=300
    restart: unless-stopped
    ports:
      - 5432:5432
      - 5454:5432
    environment:
      PGUSER: 'postgres'
      POSTGRES_PASSWORD: 'postgres'
    volumes:
      - ../startup/initdb:/docker-entrypoint-initdb.d
      - postgresdata:/var/lib/postgresql/data
    <<: *common
    healthcheck:
      # identity_service is the last db to be created in init-db.sql
      test: ['CMD', 'pg_isready', '--dbname', 'identity_service']
      interval: 10s
      timeout: 5s

  audius-cmd:
    extends:
      file: docker-compose.dev-tools.${DOCKERCOMPOSE_ENV_TYPE:-dev}.yml
      service: audius-cmd
    <<: *common

  # Identity

  identity-service-redis:
    extends:
      file: docker-compose.identity.${DOCKERCOMPOSE_ENV_TYPE:-dev}.yml
      service: identity-service-redis
    <<: *common

  identity-service:
    extends:
      file: docker-compose.identity.${DOCKERCOMPOSE_ENV_TYPE:-dev}.yml
      service: identity-service
    <<: *common

  # Healthz

  healthz:
    extends:
      file: docker-compose.healthz.yml
      service: healthz
    <<: *common

  # Protocol dashboard

  dashboard:
    image: audius-protocol-dashboard:${DASHBOARD_ENV_TYPE:-latest}
    extends:
      file: docker-compose.protocol-dashboard.${DASHBOARD_ENV_TYPE:-dev}.yml
      service: dashboard
    <<: *common

  # Uptime (standalone container used by Discovery and Content)

  uptime:
    extends:
      file: docker-compose.uptime.yml
      service: uptime
    <<: *common

  # Discovery

  discovery-provider-redis:
    extends:
      file: docker-compose.discovery.${DOCKERCOMPOSE_ENV_TYPE:-dev}.yml
      service: discovery-provider-redis
    <<: *common

  discovery-provider-notifications:
    extends:
      file: docker-compose.discovery.${DOCKERCOMPOSE_ENV_TYPE:-dev}.yml
      service: discovery-provider-notifications
    <<: *common

  discovery-provider-elasticsearch:
    extends:
      file: docker-compose.discovery.${DOCKERCOMPOSE_ENV_TYPE:-dev}.yml
      service: discovery-provider-elasticsearch
    <<: *common

  discovery-provider:
    extends:
      file: docker-compose.discovery.${DOCKERCOMPOSE_ENV_TYPE:-dev}.yml
      service: discovery-provider
    <<: *common

  discovery-provider-openresty:
    extends:
      file: docker-compose.discovery.${DOCKERCOMPOSE_ENV_TYPE:-dev}.yml
      service: discovery-provider-openresty
    <<: *common

  comms:
    # Used for pushing to docker hub in CI
    extends:
      file: docker-compose.discovery.${DOCKERCOMPOSE_ENV_TYPE:-dev}.yml
      service: comms
    <<: *common

  trpc:
    # Used for pushing to docker hub in CI
    extends:
      file: docker-compose.discovery.${DOCKERCOMPOSE_ENV_TYPE:-dev}.yml
      service: trpc
    <<: *common

  es-indexer:
    # Used for pushing to docker hub in CI
    extends:
      file: docker-compose.discovery.${DOCKERCOMPOSE_ENV_TYPE:-dev}.yml
      service: es-indexer
    <<: *common

  # Pedalboard (plugins)
  trending-challenge-rewards:
    extends:
      file: docker-compose.pedalboard.${DOCKERCOMPOSE_ENV_TYPE:-dev}.yml
      service: trending-challenge-rewards
    <<: *common

  relay:
    extends:
      file: docker-compose.pedalboard.${DOCKERCOMPOSE_ENV_TYPE:-dev}.yml
      service: relay
    <<: *common

  solana-relay:
    extends:
      file: docker-compose.pedalboard.${DOCKERCOMPOSE_ENV_TYPE:-dev}.yml
      service: solana-relay
    <<: *common

  sla-auditor:
    extends:
      file: docker-compose.pedalboard.${DOCKERCOMPOSE_ENV_TYPE:-dev}.yml
      service: sla-auditor
    <<: *common

  # DDEX

  ddex-mongo:
    extends:
      file: docker-compose.ddex.yml
      service: ddex-mongo
    <<: *common
    profiles:
      - ddex
      - ddex-release-by-release
      - ddex-batched

  ddex-mongo-init:
    extends:
      file: docker-compose.ddex.yml
      service: ddex-mongo-init
    <<: *common
    profiles:
      - ddex
      - ddex-release-by-release
      - ddex-batched

  ddex-ingester:
    extends:
      file: docker-compose.ddex.yml
      service: ddex-ingester
    <<: *common
    profiles:
      - ddex

  ddex-web:
    extends:
      file: docker-compose.ddex.yml
      service: ddex-web
    container_name: ddex-web
    <<: *common
    profiles:
      - ddex

  ddex-publisher:
    extends:
      file: docker-compose.ddex.yml
      service: ddex-publisher
    container_name: ddex-publisher
    <<: *common
    profiles:
      - ddex

  # DDEX release-by-release (only used locally, not pushed to docker hub)

  ddex-web-release-by-release:
    extends:
      file: docker-compose.ddex.yml
      service: ddex-web
    container_name: ddex-web-release-by-release
    <<: *common
    environment:
      AWS_ENDPOINT: 'http://ddex-s3-release-by-release:4566'
      DDEX_CHOREOGRAPHY: 'ERNReleaseByRelease'
    profiles:
      - ddex-release-by-release

  ddex-crawler-release-by-release:
    extends:
      file: docker-compose.ddex.yml
      service: ddex-crawler
    container_name: ddex-crawler-release-by-release
    <<: *common
    environment:
      AWS_ENDPOINT: 'http://ddex-s3-release-by-release:4566'
      DDEX_CHOREOGRAPHY: 'ERNReleaseByRelease'
    depends_on:
      ddex-mongo-init:
        condition: service_completed_successfully
      ddex-s3-release-by-release:
        condition: service_healthy
    profiles:
      - ddex-release-by-release

  ddex-parser-release-by-release:
    extends:
      file: docker-compose.ddex.yml
      service: ddex-parser
    container_name: ddex-parser-release-by-release
    <<: *common
    environment:
      AWS_ENDPOINT: 'http://ddex-s3-release-by-release:4566'
      DDEX_CHOREOGRAPHY: 'ERNReleaseByRelease'
    depends_on:
      ddex-mongo-init:
        condition: service_completed_successfully
      ddex-s3-release-by-release:
        condition: service_healthy
    profiles:
      - ddex-release-by-release

  ddex-publisher-release-by-release:
    extends:
      file: docker-compose.ddex.yml
      service: ddex-publisher
    container_name: ddex-publisher-release-by-release
    <<: *common
    environment:
      AWS_ENDPOINT: 'http://ddex-s3-release-by-release:4566'
      DDEX_CHOREOGRAPHY: 'ERNReleaseByRelease'
    depends_on:
      ddex-mongo-init:
        condition: service_completed_successfully
      ddex-s3-release-by-release:
        condition: service_healthy
    profiles:
      - ddex-release-by-release

  ddex-s3-release-by-release:
    extends:
      file: docker-compose.ddex.yml
      service: ddex-s3
    container_name: ddex-s3-release-by-release
    <<: *common
    volumes:
      - "ddex-s3-release-by-release:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
    profiles:
      - ddex-release-by-release
    # DDEX batched (only used locally, not pushed to docker hub)

  ddex-web-batched:
    extends:
      file: docker-compose.ddex.yml
      service: ddex-web
    container_name: ddex-web-batched
    <<: *common
    environment:
      AWS_ENDPOINT: 'http://ddex-s3-batched:4566'
      DDEX_CHOREOGRAPHY: 'ERNBatched'
    profiles:
      - ddex-batched

  ddex-crawler-batched:
    extends:
      file: docker-compose.ddex.yml
      service: ddex-crawler
    container_name: ddex-crawler-batched
    <<: *common
    environment:
      AWS_ENDPOINT: 'http://ddex-s3-batched:4566'
      DDEX_CHOREOGRAPHY: 'ERNBatched'
    depends_on:
      ddex-mongo-init:
        condition: service_completed_successfully
      ddex-s3-batched:
        condition: service_healthy
    profiles:
      - ddex-batched

  ddex-parser-batched:
    extends:
      file: docker-compose.ddex.yml
      service: ddex-parser
    container_name: ddex-parser-batched
    <<: *common
    environment:
      AWS_ENDPOINT: 'http://ddex-s3-batched:4566'
      DDEX_CHOREOGRAPHY: 'ERNBatched'
    depends_on:
      ddex-mongo-init:
        condition: service_completed_successfully
      ddex-s3-batched:
        condition: service_healthy
    profiles:
      - ddex-batched

  ddex-publisher-batched:
    extends:
      file: docker-compose.ddex.yml
      service: ddex-publisher
    container_name: ddex-publisher-batched
    <<: *common
    environment:
      AWS_ENDPOINT: 'http://ddex-s3-batched:4566'
      DDEX_CHOREOGRAPHY: 'ERNBatched'
    depends_on:
      ddex-mongo-init:
        condition: service_completed_successfully
      ddex-s3-batched:
        condition: service_healthy
    profiles:
      - ddex-batched

  ddex-s3-batched:
    extends:
      file: docker-compose.ddex.yml
      service: ddex-s3
    container_name: ddex-s3-batched
    <<: *common
    volumes:
      - "ddex-s3-batched:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
    profiles:
      - ddex-batched

  # Storage (content node)

  mediorum:
    extends:
      file: docker-compose.storage.${MEDIORUM_ENV_TYPE:-${DOCKERCOMPOSE_ENV_TYPE:-dev}}.yml
      service: storage
    container_name: audius-protocol-mediorum
    <<: *common

  # Blockchain

  poa-ganache:
    extends:
      file: docker-compose.blockchain.yml
      service: poa-ganache
    <<: *common

  poa-blockscout-db:
    extends:
      file: docker-compose.blockchain.yml
      service: poa-blockscout-db
    <<: *common

  poa-blockscout:
    extends:
      file: docker-compose.blockchain.yml
      service: poa-blockscout
    <<: *common

  eth-ganache:
    extends:
      file: docker-compose.blockchain.yml
      service: eth-ganache
    <<: *common

  eth-blockscout-db:
    extends:
      file: docker-compose.blockchain.yml
      service: eth-blockscout-db
    <<: *common

  eth-blockscout:
    extends:
      file: docker-compose.blockchain.yml
      service: eth-blockscout
    <<: *common

  solana-test-validator:
    extends:
      file: docker-compose.blockchain.yml
      service: solana-test-validator
    <<: *common

  solana-test-validator-build:
    extends:
      file: docker-compose.blockchain.yml
      service: solana-test-validator-build
    <<: *common

networks:
  ddex-network:


volumes:
  poa-contracts-abis:
  eth-contracts-abis:
  solana-programs-idl:
  audius-libs:
  postgresdata:
  mediorum:
  legacy_creator_file_storage:
  ddex-mongo-db:
  ddex-s3-release-by-release:
  ddex-s3-batched:
