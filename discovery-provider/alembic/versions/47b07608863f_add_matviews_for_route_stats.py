"""Add matviews for route stats

Revision ID: 47b07608863f
Revises: d579207034fc
Create Date: 2020-11-19 14:32:18.832920

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '47b07608863f'
down_revision = 'd579207034fc'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    connection = op.get_bind()
    connection.execute('''

    --- Create matviews for easier protocol dashboard querying
    CREATE MATERIALIZED VIEW route_metrics_day_bucket AS
	SELECT
		COUNT (DISTINCT route_metrics.ip) as "unique_count",
		SUM (route_metrics.count) as "count",
		date_trunc('day', route_metrics.timestamp) as "time"
	FROM route_metrics
	GROUP BY date_trunc('day', route_metrics.timestamp);

    CREATE MATERIALIZED VIEW route_metrics_month_bucket AS
	SELECT
		COUNT (DISTINCT route_metrics.ip) as "unique_count",
		SUM (route_metrics.count) as "count",
		date_trunc('month', route_metrics.timestamp) as "time"
	FROM route_metrics
	GROUP BY date_trunc('month', route_metrics.timestamp);

    CREATE MATERIALIZED VIEW route_metrics_century_bucket AS
	SELECT
		COUNT (DISTINCT route_metrics.ip) as "unique_count",
		SUM (route_metrics.count) as "count",
		date_trunc('century', route_metrics.timestamp) as "time"
	FROM route_metrics
	GROUP BY date_trunc('century', route_metrics.timestamp);
    ''')


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    # ### end Alembic commands ###
    connection = op.get_bind()
    connection.execute('''
    DROP MATERIALIZED VIEW route_metrics_day_bucket;
    DROP MATERIALIZED VIEW route_metrics_month_bucket;
    ''')
