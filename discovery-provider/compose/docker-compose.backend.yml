# Compose file to run the discovery backend stack (web server and celery workers)
version: '3'
services:
  worker:
    extends:
      file: docker-compose.common.yml
      service: discovery-provider
    container_name: worker
    depends_on:
      discovery-provider-db:
        condition: service_healthy
      redis-server:
        condition: service_started
    environment:
      - audius_service=worker
      - audius_db_url=postgresql+psycopg2://postgres:postgres@${COMPOSE_PROJECT_NAME}_discovery-provider-db_1:5432/audius_discovery
      - audius_db_url_read_replica=postgresql+psycopg2://postgres:postgres@${COMPOSE_PROJECT_NAME}_discovery-provider-db_1:5432/audius_discovery

  beat:
    extends:
      file: docker-compose.common.yml
      service: discovery-provider
    container_name: beat
    depends_on:
      discovery-provider-db:
        condition: service_healthy
      redis-server:
        condition: service_started
    environment:
      - audius_service=beat
      - audius_db_url=postgresql+psycopg2://postgres:postgres@${COMPOSE_PROJECT_NAME}_discovery-provider-db_1:5432/audius_discovery
      - audius_db_url_read_replica=postgresql+psycopg2://postgres:postgres@${COMPOSE_PROJECT_NAME}_discovery-provider-db_1:5432/audius_discovery

  web-server:
    extends:
      file: docker-compose.common.yml
      service: discovery-provider
    container_name: server
    depends_on:
      discovery-provider-db:
        condition: service_healthy
      redis-server:
        condition: service_started
    ports:
      - '${audius_server_port}:${audius_server_port}'
    environment:
      - audius_service=server
      - audius_db_url=postgresql+psycopg2://postgres:postgres@${COMPOSE_PROJECT_NAME}_discovery-provider-db_1:5432/audius_discovery
      - audius_db_url_read_replica=postgresql+psycopg2://postgres:postgres@${COMPOSE_PROJECT_NAME}_discovery-provider-db_1:5432/audius_discovery


networks:
  audius_dev:
    external: true
