worker_processes 1;

error_log logs/error.log;

env audius_openresty_accept_redirect_from;
env audius_openresty_public_url;
env audius_openresty_rate_limit;
env audius_openresty_redirect_to;
env audius_openresty_rsa_private_key;
env audius_openresty_rsa_public_key;

events {
    worker_connections 1024;
}

http {
    lua_package_path "/home/mukundan/Documents/misc/nginx-test/conf/?.lua;;";

    lua_shared_dict my_limit_count_store 100m;
    lua_shared_dict rsa_public_key_store 10m;
    lua_shared_dict nonce_store 10m;

    server {
        listen 5000;

        location = /openresty_pubkey {
            set_by_lua $audius_openresty_rsa_public_key 'return require("main").get_public_key()';
            return 200 '$audius_openresty_rsa_public_key';
        }

        location ~* .*_(check|version) {
            proxy_pass http://127.0.0.1:3000;
        }

        location / {
            access_by_lua_block {
                local main = require "main"
                local limit_count = require "resty.limit.count"

                if main.get_no_redirect() then
                    return
                end

                if ngx.var.redirect_from and ngx.var.redirect_nonce and ngx.var.redirect_sig then
                    if main.verify(ngx.var.redirect_from, ngx.var.redirect_nonce, ngx.var.redirect_sig) then
                        return
                    end
                end

                local lim, err = limit_count.new("my_limit_count_store", main.get_rate_limit(), 1)
                if not lim then
                    ngx.log(ngx.ERR, "failed to instantiate a resty.limit.req object: ", err)
                    return ngx.exit(500)
                end

                local delay, err = lim:incoming("k", true)
                if not delay then
                    if err == "rejected" then
                        local url = main.get_redirect_to() .. ngx.var.request_uri
                        url = url .. ((ngx.var.is_args == "?") and "&" or "?") .. main.get_redirect_args()
                        return ngx.redirect(url)
                    end

                    ngx.log(ngx.ERR, "failed to limit req: ", err)
                    return ngx.exit(500)
                end
            }

            proxy_pass http://127.0.0.1:3000;
        }
    }
}
