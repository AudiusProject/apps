version: "3.9"

x-nats-nodes-healthy: &nats-nodes-healthy
  nats-storage-1:
    condition: service_healthy
  nats-storage-2:
    condition: service_healthy
  nats-storage-3:
    condition: service_healthy
  nats-storage-4:
    condition: service_healthy
  nats-discovery-1:
    condition: service_healthy
  nats-discovery-2:
    condition: service_healthy
  nats-discovery-3:
    condition: service_healthy

x-comms-environment: &comms-environment
  AUDIUS_REBALANCE_INTERVAL_HOURS: "0.005" # check for unhealthy nodes and update healthy node set every 18 seconds
  AUDIUS_HEALTH_TTL_HOURS: "0.005" # consider a node unhealthy if it hasn't self-reported "OK" status in the last 18 seconds
  AUDIUS_REPORT_OK_INTERVAL_SECONDS: 4
  AUDIUS_SHARD_LENGTH: 1
  AUDIUS_NATS_ENABLE_JETSTREAM: true
  AUDIUS_DEV_ONLY_REGISTERED_NODES: '
        [
          {
            "id": "content-node::1",
            "spId": "1",
            "endpoint": "http://audius-protocol-storage-1",
            "delegateOwnerWallet": "0x1c185053c2259f72fd023ED89B9b3EBbD841DA0F",
            "owner": { "id": "0x339511506f7BfB5f5d7042b450B9D450626dbB91" },
            "type": { "id": "content-node" }
          },
          {
            "id": "content-node::2",
            "spId": "2",
            "endpoint": "http://audius-protocol-storage-2",
            "delegateOwnerWallet": "0x90b8d2655A7C268d0fA31758A714e583AE54489D",
            "owner": { "id": "0x11327A21bc4dE71a1274D7C1e2c94D50AdeeBB88" },
            "type": { "id": "content-node" }
          },
          {
            "id": "content-node::3",
            "spId": "3",
            "endpoint": "http://audius-protocol-storage-3",
            "delegateOwnerWallet": "0xb7b9599EeB2FD9237C94cFf02d74368Bb2df959B",
            "owner": { "id": "0x339511506f7BfB5f5d7042b450B9D450626dbB91" },
            "type": { "id": "content-node" }
          },
          {
            "id": "content-node::4",
            "spId": "4",
            "endpoint": "http://audius-protocol-storage-4",
            "delegateOwnerWallet": "0xfa4f42633Cb0c72Aa35D3D1A3566abb7142c7b16",
            "owner": { "id": "0x11327A21bc4dE71a1274D7C1e2c94D50AdeeBB88" },
            "type": { "id": "content-node" }
          },
          {
            "id": "discovery-node::1",
            "spId": "5",
            "endpoint": "http://audius-protocol-comms-discovery-1",
            "delegateOwnerWallet": "0x123d0813710D55A9C38A2D7BC502Ff00A1a0279e",
            "owner": { "id": "0x339511506f7BfB5f5d7042b450B9D450626dbB91" },
            "type": { "id": "discovery-node" }
          },
          {
            "id": "discovery-node::2",
            "spId": "6",
            "endpoint": "http://audius-protocol-comms-discovery-2",
            "delegateOwnerWallet": "0x9262c9A1b172fF2A9C027B55862389d00b68A26a",
            "owner": { "id": "0x11327A21bc4dE71a1274D7C1e2c94D50AdeeBB88" },
            "type": { "id": "discovery-node" }
          },
          {
            "id": "discovery-node::3",
            "spId": "7",
            "endpoint": "http://audius-protocol-comms-discovery-3",
            "delegateOwnerWallet": "0xBc2550Ae74fbbDF4eC30A8E65dd845a5a8510eb4",
            "owner": { "id": "0x339511506f7BfB5f5d7042b450B9D450626dbB91" },
            "type": { "id": "discovery-node" }
          }
        ]'

x-nats: &nats
    build:
      context: comms
      dockerfile: Dockerfile
      target: builder
      args:
        GOARCH: arm64
    restart: unless-stopped
    stop_signal: SIGKILL
    command: nats
    depends_on:
      ingress:
        condition: service_started
    healthcheck:
      # does the cluster have at least 7 nodes peered (4 storage, 3 discovery)?
      test: wget -qO- http://localhost:8924/nats/jsz | grep -o '"cluster_size":[[:space:]]*[0-9]*' | awk '{if ($$2 < 7) {exit 1}}'
      interval: 5s
      retries: 15
      start_period: 10s
      timeout: 1s
    volumes:
      - ./comms/natsd:/app/natsd
      - ./comms/shared:/app/shared
    profiles:
      - comms

x-storage: &storage
    build:
      context: comms
      dockerfile: Dockerfile
      target: builder
      args:
        GOARCH: arm64
    restart: unless-stopped
    stop_signal: SIGKILL
    command: storage
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:8926/storage || exit 1
      interval: 5s
      retries: 20
      start_period: 30s
      timeout: 1s
    depends_on:
      ingress:
        condition: service_started
      <<: *nats-nodes-healthy
    volumes:
      - ./comms/storage:/app/storage
      - ./comms/shared:/app/shared
      - /app/storage/storageserver/weather-map # exclude weather-map and its heavy node_modules
      - ./comms/storage/storageserver/weather-map/dist:/app/storage/storageserver/weather-map/dist
    profiles:
      - comms

x-discovery: &discovery
    build:
      context: comms
      dockerfile: Dockerfile
      target: builder
      args:
        GOARCH: arm64
    restart: unless-stopped
    stop_signal: SIGKILL
    command: discovery
    volumes:
      - ./comms/discovery:/app/discovery
      - ./comms/shared:/app/shared
    depends_on:
      comms-discovery-db-1:
        condition: service_started
      <<: *nats-nodes-healthy
    profiles:
      - comms

services:
  # NATS

  nats-storage-1:
    container_name: audius-protocol-nats-storage-1
    <<: *nats
    environment:
      <<: *comms-environment
      AUDIUS_DELEGATE_PRIVATE_KEY: "293589cdf207ed2f2253bb72b17bb7f2cfe399cdc34712b1d32908d969682238" # Public key: "0x1c185053c2259f72fd023ED89B9b3EBbD841DA0F"
      AUDIUS_TEST_HOST: "audius-protocol-nats-storage-1"

  nats-storage-2:
    container_name: audius-protocol-nats-storage-2
    <<: *nats
    environment:
      <<: *comms-environment
      AUDIUS_DELEGATE_PRIVATE_KEY: "1ca1082d2304d96c2e6a3e551226e72e2cb54fddfe69b946b0efc2d9b43c19fc" # Public key: "0x90b8d2655A7C268d0fA31758A714e583AE54489D"
      AUDIUS_TEST_HOST: "audius-protocol-nats-storage-2"

  nats-storage-3:
    container_name: audius-protocol-nats-storage-3
    <<: *nats
    environment:
      <<: *comms-environment
      AUDIUS_DELEGATE_PRIVATE_KEY: "12712efcf90774399e272f8fc89ef264058b4cdd7f7f86956052050cbfb4350c" # Public key: "0xb7b9599EeB2FD9237C94cFf02d74368Bb2df959B"
      AUDIUS_TEST_HOST: "audius-protocol-nats-storage-3"

  nats-storage-4:
    container_name: audius-protocol-nats-storage-4
    <<: *nats
    environment:
      <<: *comms-environment
      AUDIUS_DELEGATE_PRIVATE_KEY: "2617e6258025c60b5aa270e02ff2247eefab37c7b463b2a870104862870ad3fb" # Public key: "0xfa4f42633Cb0c72Aa35D3D1A3566abb7142c7b16"
      AUDIUS_TEST_HOST: "audius-protocol-nats-storage-4"

  nats-discovery-1:
    container_name: audius-protocol-nats-discovery-1
    <<: *nats
    environment:
      <<: *comms-environment
      AUDIUS_DELEGATE_PRIVATE_KEY: "c82ad757622db5a148089e0a8fc1741cefa8677ab56a2ac9e38dac905c5ad7c7" # Public key: "0x123d0813710D55A9C38A2D7BC502Ff00A1a0279e"
      AUDIUS_TEST_HOST: "audius-protocol-nats-discovery-1"

  nats-discovery-2:
    container_name: audius-protocol-nats-discovery-2
    <<: *nats
    environment:
      <<: *comms-environment
      AUDIUS_DELEGATE_PRIVATE_KEY: "d2b12371a062b73ce665288f894844ab75760d0ed0c580ff19d21b54d260ceb2" # Public key: "0x9262c9A1b172fF2A9C027B55862389d00b68A26a"
      AUDIUS_TEST_HOST: "audius-protocol-nats-discovery-2"

  nats-discovery-3:
    container_name: audius-protocol-nats-discovery-3
    <<: *nats
    environment:
      <<: *comms-environment
      AUDIUS_DELEGATE_PRIVATE_KEY: "6569932dff9fbe7c04382f87ac7098f90e7aa5cb0fe636b4e5c3cb4e30668812" # Public key: "0xBc2550Ae74fbbDF4eC30A8E65dd845a5a8510eb4"
      AUDIUS_TEST_HOST: "audius-protocol-nats-discovery-3"

  # STORAGE V2

  storage-1:
    container_name: audius-protocol-storage-1
    <<: *storage
    environment:
      <<: *comms-environment
      AUDIUS_DELEGATE_PRIVATE_KEY: "293589cdf207ed2f2253bb72b17bb7f2cfe399cdc34712b1d32908d969682238" # Public key: "0x1c185053c2259f72fd023ED89B9b3EBbD841DA0F"
      AUDIUS_TEST_HOST: "audius-protocol-nats-storage-1"
      NAME: "audius-protocol-nats-storage-1" # Only used to display which node processed each job in jobs tabls

  storage-2:
    container_name: audius-protocol-storage-2
    <<: *storage
    environment:
      <<: *comms-environment
      AUDIUS_DELEGATE_PRIVATE_KEY: "1ca1082d2304d96c2e6a3e551226e72e2cb54fddfe69b946b0efc2d9b43c19fc" # Public key: "0x90b8d2655A7C268d0fA31758A714e583AE54489D"
      AUDIUS_TEST_HOST: "audius-protocol-nats-storage-2"
      NAME: "audius-protocol-nats-storage-2" # Only used to display which node processed each job in jobs tabls

  storage-3:
    container_name: audius-protocol-storage-3
    <<: *storage
    environment:
      <<: *comms-environment
      AUDIUS_DELEGATE_PRIVATE_KEY: "12712efcf90774399e272f8fc89ef264058b4cdd7f7f86956052050cbfb4350c" # Public key: "0xb7b9599EeB2FD9237C94cFf02d74368Bb2df959B"
      AUDIUS_TEST_HOST: "audius-protocol-nats-storage-3"
      NAME: "audius-protocol-nats-storage-3" # Only used to display which node processed each job in jobs tabls

  storage-4:
    container_name: audius-protocol-storage-4
    <<: *storage
    environment:
      <<: *comms-environment
      AUDIUS_DELEGATE_PRIVATE_KEY: "2617e6258025c60b5aa270e02ff2247eefab37c7b463b2a870104862870ad3fb" # Public key: "0xfa4f42633Cb0c72Aa35D3D1A3566abb7142c7b16"
      AUDIUS_TEST_HOST: "audius-protocol-nats-storage-4"
      NAME: "audius-protocol-nats-storage-1" # Only used to display which node processed each job in jobs tabls

  # DISCOVERY (comms, not a full discovery provider)

  comms-discovery-1:
    container_name: audius-protocol-comms-discovery-1
    <<: *discovery
    environment:
      <<: *comms-environment
      audius_db_url: "postgresql://postgres:postgres@comms-discovery-db-1:5432/com1?sslmode=disable"
      AUDIUS_DELEGATE_PRIVATE_KEY: "c82ad757622db5a148089e0a8fc1741cefa8677ab56a2ac9e38dac905c5ad7c7" # Public key: "0x123d0813710D55A9C38A2D7BC502Ff00A1a0279e"
      NATS_SERVER_URL: "nats://audius-protocol-nats-discovery-1:4222"
    
  comms-discovery-2:
    container_name: audius-protocol-comms-discovery-2
    <<: *discovery
    environment:
      <<: *comms-environment
      audius_db_url: "postgresql://postgres:postgres@comms-discovery-db-1:5432/com1?sslmode=disable"
      AUDIUS_DELEGATE_PRIVATE_KEY: "d2b12371a062b73ce665288f894844ab75760d0ed0c580ff19d21b54d260ceb2" # Public key: "0x9262c9A1b172fF2A9C027B55862389d00b68A26a"
      NATS_SERVER_URL: "nats://audius-protocol-nats-discovery-2:4222"

  comms-discovery-3:
    container_name: audius-protocol-comms-discovery-3
    <<: *discovery
    environment:
      <<: *comms-environment
      audius_db_url: "postgresql://postgres:postgres@comms-discovery-db-1:5432/com1?sslmode=disable"
      AUDIUS_DELEGATE_PRIVATE_KEY: "6569932dff9fbe7c04382f87ac7098f90e7aa5cb0fe636b4e5c3cb4e30668812" # Public key: "0xBc2550Ae74fbbDF4eC30A8E65dd845a5a8510eb4"
      NATS_SERVER_URL: "nats://audius-protocol-nats-discovery-3:4222"

  # TEST

  comms-test:
    container_name: comms-test
    build:
      context: comms
      dockerfile: Dockerfile
      target: builder
      args:
        GOARCH: arm64
    environment:
      <<: *comms-environment
      AUDIUS_DELEGATE_PRIVATE_KEY: "293589cdf207ed2f2253bb72b17bb7f2cfe399cdc34712b1d32908d969682238" # Public key: "0x1c185053c2259f72fd023ED89B9b3EBbD841DA0F"
      AUDIUS_TEST_HOST: "audius-protocol-nats-storage-1"
      NATS_SERVER_URL: "nats://audius-protocol-nats-storage-1:4222"
      audius_db_url: "postgresql://postgres:postgres@comms-discovery-db-1:5432/audius_discovery?sslmode=disable"
    command: -c .air.test.toml
    volumes:
      - ./comms/:/app
    depends_on:
      ingress:
        condition: service_started
      comms-discovery-db-1:
        condition: service_started
      storage-1:
        condition: service_healthy
      storage-2:
        condition: service_healthy
      storage-3:
        condition: service_healthy
      storage-4:
        condition: service_healthy
      comms-discovery-1:
        condition: service_started
      comms-discovery-2:
        condition: service_started
      comms-discovery-3:
        condition: service_started
      <<: *nats-nodes-healthy
