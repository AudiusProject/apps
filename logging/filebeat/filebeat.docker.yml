filebeat.autodiscover:
  providers:
    - type: docker
      templates:
        - config:
            - type: container
              paths:
                - "/var/lib/docker/containers/${data.docker.container.id}/*.log"
              json.message_key: msg
              # when included, the entire index is empty
              # multiline.pattern: '^{'
              # multiline.negate: true
              # multiline.match: after
              processors:
                - add_cloud_metadata: ~
                - add_docker_metadata: ~
                - add_host_metadata: ~
                - add_locale: ~
                - rename:
                    fields:
                      - from: "json.msg"
                        to: "audius.message"
                      - from: "json.level"
                        to: "audius.level"
                      - from: "json.funcName"
                        to: "audius.func"
                      - from: "json.lineno"
                        to: "audius.lineno"
                      - from: "json.pathname"
                        to: "audius.pathname"
                      - from: "json.service"
                        to: "audius.service"
                      - from: "cloud.instance.name"
                        to: "audius.hostname"
                    ignore_missing: true
                    fail_on_error: true
                - copy_fields:
                    fields:
                      - from: "container.name"
                        to: "audius.container"
                    ignore_missing: true
                    fail_on_error: true
          condition.or:
            - contains:
                docker.container.image: "dn1_web-server"
        - config:
            - type: container
              paths:
                - "/var/lib/docker/containers/${data.docker.container.id}/*.log"
              json.message_key: msg
              multiline.pattern: '^{'
              multiline.negate: true
              multiline.match: after
              processors:
                - add_cloud_metadata: ~
                - add_docker_metadata: ~
                - add_host_metadata: ~
                - add_locale: ~
                - rename:
                    fields:
                      - from: "json.msg"
                        to: "audius.message"
                      - from: "json.logLevel"
                        to: "audius.level"
                      - from: "cloud.instance.name"
                        to: "audius.hostname"
                    ignore_missing: true
                    fail_on_error: true
                - copy_fields:
                    fields:
                      - from: "container.name"
                        to: "audius.container"
                    ignore_missing: true
                    fail_on_error: true
          condition.or:
            - contains:
                docker.container.image: "creator-node"
        - config:
            - type: container
              paths:
                - "/var/lib/docker/containers/${data.docker.container.id}/*.log"
              json.message_key: message
              json.add_error_key: true
              multiline.pattern: '^{'
              multiline.negate: true
              multiline.match: after
              processors:
                - add_cloud_metadata: ~
                - add_docker_metadata: ~
                - add_host_metadata: ~
                - add_locale: ~
                - rename:
                    fields:
                      - from: "json.msg"
                        to: "audius.message"
                      - from: "cloud.instance.name"
                        to: "audius.hostname"
                    ignore_missing: true
                    fail_on_error: true
                - copy_fields:
                    fields:
                      - from: "container.name"
                        to: "audius.container"
                    ignore_missing: true
                    fail_on_error: true
          condition.or:
            - contains:
                docker.container.image: "audius-identity-service_identity-service"
        - config:
            - type: container
              paths:
                - "/var/lib/docker/containers/${data.docker.container.id}/*.log"
              json.message_key: msg
              multiline.pattern: '^{'
              multiline.negate: true
              multiline.match: after
              processors:
                - add_cloud_metadata: ~
                - add_docker_metadata: ~
                - add_host_metadata: ~
                - add_locale: ~
                - rename:
                    fields:
                      - from: "json.message"
                        to: "audius.message"
                      - from: "json.log.level"
                        to: "audius.level"
                      - from: "cloud.instance.name"
                        to: "audius.hostname"
                    ignore_missing: true
                    fail_on_error: true
                - copy_fields:
                    fields:
                      - from: "container.name"
                        to: "audius.container"
                    ignore_missing: true
                    fail_on_error: true
          condition.or:
            - contains:
                docker.container.image: "filebeat"
        - config:
            - type: container
              paths:
                - "/var/lib/docker/containers/${data.docker.container.id}/*.log"
              processors:
                - add_cloud_metadata: ~
                - add_docker_metadata: ~
                - add_host_metadata: ~
                - add_locale: ~
                - rename:
                    fields:
                      - from: "message"
                        to: "audius.message"
                      - from: "cloud.instance.name"
                        to: "audius.hostname"
                    ignore_missing: true
                    fail_on_error: true
                - copy_fields:
                    fields:
                      - from: "container.name"
                        to: "audius.container"
                    ignore_missing: true
                    fail_on_error: true
          condition.or:
            - contains:
                docker.container.image: "metricbeat"
            - contains:
                docker.container.image: "redis"
            - contains:
                docker.container.image: "postgres"
            - contains:
                docker.container.image: "solana-programs"
            - contains:
                docker.container.image: "ganache"
        - config:
            - type: container
              paths:
                - "/var/lib/docker/containers/${data.docker.container.id}/*.log"
          condition.and:
            - not.contains:
                docker.container.image: "dn1_web-server"
            - not.contains:
                docker.container.image: "creator-node"
            - not.equals:
                docker.container.image: "audius-identity-service_identity-service"
            - not.contains:
                docker.container.image: "beat"
            - not.contains:
                docker.container.image: "redis"
            - not.contains:
                docker.container.image: "postgres"
            - not.contains:
                docker.container.image: "solana-programs"
            - not.contains:
                docker.container.image: "ganache"

output.elasticsearch:
  hosts: "${ELASTIC_ENDPOINT}"
  api_key: "${API_ID}:${API_KEY}"
  indices:
    - index: "filebeat-${FILEBEAT_INDEX}-app-%{[agent.version]}-%{+yyyy.MM.dd}"
      when.or:
        - regexp:
            container.name: dn._web-server_.
        - regexp:
            container.name: cn._creator-node_.
        - regexp:
            container.name: audius-identity-service_identity-service_.
    - index: "filebeat-${FILEBEAT_INDEX}-db-%{[agent.version]}-%{+yyyy.MM.dd}"
      when.or:
        - regexp:
            container.name: .*redis.*
        - regexp:
            container.name: .*discovery-provider-db.*
    - index: "filebeat-${FILEBEAT_INDEX}-beats-%{[agent.version]}-%{+yyyy.MM.dd}"
      when.or:
        - equals:
            container.name: filebeat
        - equals:
            container.name: metricbeat
    - index: "filebeat-${FILEBEAT_INDEX}-misc-%{[agent.version]}-%{+yyyy.MM.dd}"

cloud.id: "${ELASTIC_CLOUD_ID}"
logging.json: true
logging.to_files: false
logging.metrics.enabled: false
logging.to_syslog: false
setup.ilm.check_exists: false
output.file:
  enabled: false
monitoring:
  enabled: false

output.console:
  enabled: false
  codec.json:
    pretty: true
    escape_html: false  

logging.metrics.enabled: false
