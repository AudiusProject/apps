import { useEffect } from 'react'

import { useCollection } from '@audius/common/api'
import { imageBlank } from '@audius/common/assets'
import { SquareSizes } from '@audius/common/models'
import { Button, IconPencil } from '@audius/harmony'
import { pick } from 'lodash'
import { Link } from 'react-router-dom'

import DynamicImage from 'components/dynamic-image/DynamicImage'
import { useCollectionCoverArt } from 'hooks/useCollectionCoverArt'

import styles from './CollectionHeader.module.css'

const messages = {
  addArtwork: 'Add Artwork',
  changeArtwork: 'Change Artwork',
  removeArtwork: 'Remove Artwork',
  coverArtAltText: 'Collection Cover Art'
}

type ArtworkProps = {
  collectionId: number
  callback: () => void
  isOwner: boolean
}

export const Artwork = (props: ArtworkProps) => {
  const { collectionId, callback, isOwner } = props

  const { data: partialCollection } = useCollection(collectionId, {
    select: (collection) =>
      pick(collection, 'is_image_autogenerated', 'permalink')
  })
  const { is_image_autogenerated, permalink } = partialCollection ?? {}

  const image = useCollectionCoverArt({
    collectionId,
    size: SquareSizes.SIZE_1000_BY_1000
  })

  const hasImage = image && image !== imageBlank

  useEffect(() => {
    // If there's a gradient, just immediately call back
    if (image || image === '') {
      callback()
    }
  }, [image, callback])

  return (
    <DynamicImage
      wrapperClassName={styles.coverArtWrapper}
      alt={messages.coverArtAltText}
      className={styles.coverArt}
      image={image}
    >
      {isOwner ? (
        <span className={styles.imageEditButtonWrapper}>
          <Button variant='tertiary' iconLeft={IconPencil} asChild>
            <Link
              to={{
                pathname: `${permalink}/edit`,
                search:
                  hasImage && !is_image_autogenerated
                    ? undefined
                    : '?focus=artwork'
              }}
            >
              {hasImage && !is_image_autogenerated
                ? messages.removeArtwork
                : hasImage
                  ? messages.changeArtwork
                  : messages.addArtwork}
            </Link>
          </Button>
        </span>
      ) : null}
    </DynamicImage>
  )
}
